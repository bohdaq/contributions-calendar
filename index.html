<contributions-calendar></contributions-calendar>

<template id="day-template">
    <style>
        .day {
            margin: 1px;
            height: 1rem;
            width: 1rem;
            background-color: #ebedf0;
        }

        .day[one-quarter] {
            background-color: #c6e48b;
        }

        .day[two-quarters] {
            background-color: #7bc96f;
        }

        .day[three-quarters] {
            background-color: #239a3b;
        }

        .day[four-quarters] {
            background-color: #239a3b;
        }
    </style>
    <div class="day">

    </div>
</template>

<script>
    document.addEventListener("contributions-calendar-day-selected", calendarListener);
    function calendarListener(event) {
        console.log('calendarListener', event);
    }

    customElements.define('contributions-calendar',
        class extends HTMLElement {
            constructor() {
                super();

                const shadowRoot = this.attachShadow({ mode: 'open'});




                const NUMBER_OF_WEEKS = 52;
                const NUMBER_OF_DAYS_IN_WEEK = 7;
                const START_DATE = "2019-01-06T00:32:00.649Z";
                const MILLIS_START_DATE = new Date('2019-01-06T00:00:00.000Z').getTime();
                const NUMBER_OF_MILLISECONDS_IN_DAY = 86400000;

                let MAX_CONTRIBUTIONS_NUMBER = 0;
                let days_array = []

                fetch('/timestamps.json')
                .then(response => response.json())
                .then(data => init(data));


                function init(contributions) {
                    let date = MILLIS_START_DATE;

                    days_array = build_days_array(contributions, date, days_array);

                    build_widget(days_array);
                }

                function build_days_array(contributions, date, days_array) {
                    for (let i=0; i<NUMBER_OF_WEEKS; i++) {
                        for (let j=0; j<NUMBER_OF_DAYS_IN_WEEK; j++) {
                            let date_contribution = {};
                            if (!(i===0 && j===0)) {
                                date += NUMBER_OF_MILLISECONDS_IN_DAY;
                            }

                            let count = count_contributions(date, contributions);

                            date_contribution = {
                                    count: count,
                                    date: date
                            }

                            days_array.push(date_contribution);
                        }
                    }

                    return days_array;
                }

                function count_contributions(date, contributions) {
                        let start_date_in_millis = date;
                        let end_date_in_millis = date + NUMBER_OF_MILLISECONDS_IN_DAY;
                        let count = 0;

                        for (let i=0; i<contributions.length; i++) {
                            let contribution = contributions[i];
                            let contribution_timestamp_in_millis = new Date(contribution).getTime();

                            if (contribution_timestamp_in_millis >= start_date_in_millis && contribution_timestamp_in_millis < end_date_in_millis) {
                                count += 1;
                            }
                        }

                        if (count > MAX_CONTRIBUTIONS_NUMBER) {
                            MAX_CONTRIBUTIONS_NUMBER = count;
                        }

                        return count;
                }

                function build_widget(days_array) {
                    const parser = new DOMParser();
                    const container_template_string = `
                        <template id="container-template">
                            <style>
                                .container {
                                    display: flex;
                                }
                            </style>
                            <div class="container">

                            </div>
                        </template>
                    `;


                    const container_template = parser.parseFromString(container_template_string, 'text/html');
                    const container = container_template.querySelector("#container-template");
                    const container_clone = container.content.cloneNode(true);

                    for (let i=0; i<NUMBER_OF_WEEKS; i++) {
                        let week = days_array.splice(0, 7);


                        const week_template_string = `
                            <template id="week-template">
                                <div class="week">

                                </div>
                            </template>
                        `;

                        const week_template = parser.parseFromString(week_template_string, 'text/html').querySelector("#week-template");
                        const week_clone = week_template.content.cloneNode(true);
                        const week_container = week_clone.querySelector(".week");
                        week_container.id = `week-${i}`;

                        for (let j=0; j<NUMBER_OF_DAYS_IN_WEEK; j++) {
                            const day_template = document.querySelector("#day-template");
                            const day_clone = day_template.content.cloneNode("#day-template");

                            let day_container = day_clone.querySelector('.day');

                            const date_contribution = week[j];

                            day_container.title = date_contribution.count;
                            day_container.id = `week-${i}-day-${j}`;
                            day_container.setAttribute('date', date_contribution.date);
                            day_container.setAttribute('contributions', date_contribution.count);

                            let percentage = 0;
                            if (date_contribution.count) {
                                let percentage = date_contribution.count / MAX_CONTRIBUTIONS_NUMBER
                                if (percentage >= 0 && percentage <= 0.25) {
                                    day_container.setAttribute('one-quarter', '');
                                } else if (percentage > 0.25 && percentage <= 0.5) {
                                    day_container.setAttribute('two-quarters', '');
                                } else if (percentage > 0.5 && percentage <= 0.75) {
                                    day_container.setAttribute('three-quarters', '');
                                } else if (percentage > 0.75 && percentage <= 1) {
                                    day_container.setAttribute('four-quarters', '');
                                }
                            }

                            week_container.appendChild(day_clone);
                        }

                        container_clone.querySelector('.container').appendChild(week_clone);
                        container_clone.querySelector('.container').addEventListener("click", clickListener);
                    }


                    shadowRoot.appendChild(container_clone);


                    function clickListener(event, detail) {
                        let rootElement = event.composedPath()[0];
                        if (rootElement.className === 'day') {
                            const date = rootElement.getAttribute('date');
                            const contributions = rootElement.getAttribute('contributions') | 0;

                            rootElement.dispatchEvent(new CustomEvent("contributions-calendar-day-selected", {
                                detail: {
                                    date: date,
                                    contributions: contributions,
                                },
                                composed: true,
                                bubbles: true,
                            }));
                        }
                    }
                }




            }
        }
    );


</script>
